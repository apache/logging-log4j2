<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Garbage-free Steady State Logging :: Apache Log4j</title>
    <link rel="canonical" href="https://logging.apache.org/log4j/2.x/manual/garbagefree.html">
    <meta name="generator" content="Antora 3.2.0-alpha.4">
<link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/../_images/favicon.ico" type="image/x-icon">
<!-- `@asciidoctor/tabs` extension styles -->
<link rel="stylesheet" href="../_/css/vendor/tabs.css">
<style>
  /* `page-toclevels` greater than 4 are not supported by Antora UI, patching it: */
  .toc .toc-menu li[data-level="4"] a {
    padding-left: 2.75rem
  }
  /* Replace the default highlight.js color for strings from red to green: */
  .hljs-string {
    color: #0f8532;
  }
</style>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <img src="../_/../_images/logo-small-white.png" alt="Apache Log4j"/>
      </div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://logging.apache.org">a subproject of&nbsp;<strong>Apache Logging Services</strong></a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ROOT" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Home</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../download.html">Download</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../runtime-dependencies.html">Runtime Dependencies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes.html">Release Notes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../support.html">Support</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../thanks.html">Thanks</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Learn</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Manual</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="migration.html">Migrating from Log4j 1.x to 2.x</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="api.html">Log4j API</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="logbuilder.html">Log Builder</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="flowtracing.html">Flow Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="markers.html">Markers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="eventlogging.html">Event Logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="messages.html">Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="thread-context.html">Thread Context</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="scoped-context.html">Scoped Context</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="resource-logger.html">Resource Logging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="usage.html">Usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cloud.html">Using Log4j in Cloud Enabled Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="lookups.html">Lookups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="appenders.html">Appenders</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="layouts.html">Layouts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="json-template-layout.html">JSON Template Layout</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="filters.html">Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="async.html">Lock-free Asynchronous Loggers for Low-Latency Logging</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="garbagefree.html">Garbage-free Steady State Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="extending.html">Extending Log4j</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="plugins.html">Plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="customconfig.html">Programmatic Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="customloglevels.html">Custom Log Levels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jmx.html">JMX</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logsep.html">Logging Separation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="performance.html">Performance</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../plugin-reference.html">Plugin reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../javadoc.html">Java API reference</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../articles.html">Articles</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../faq.html">F.A.Q.</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Components</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-api.html">Log4j API</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-1.2-api.html">Log4j 1.2 Bridge</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-slf4j-impl.html">Log4j SLF4J Binding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-jul.html">Log4j JDK Logging Adapter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-jpl.html">Log4j JDK Platform Logging Adapter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-to-slf4j.html">Log4j to SLF4J Adapter</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-flume-ng.html">Flume Appender</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-mongodb3.html">MongoDB 3 appender</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-mongodb4.html">MongoDB 4 appender</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-iostreams.html">Log4j IOStreams</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-docker.html">Log4j Docker Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../log4j-spring-cloud-config-client.html">Log4j Spring Cloud Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Related projects</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/jakarta">Log4j Jakarta EE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/jmx-gui">Log4j JMX GUI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/kotlin">Log4j Kotlin</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/scala">Log4j Scala</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/tools">Log4j Tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="/log4j/transform">Log4j Transformation Tools</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Home</a></li>
    <li>Learn</li>
    <li><a href="index.html">Manual</a></li>
    <li><a href="garbagefree.html">Garbage-free Steady State Logging</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/apache/logging-log4j2/edit/2.x/src/site/antora/modules/ROOT/pages/manual/garbagefree.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="4">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Garbage-free Steady State Logging</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Garbage collection pauses are a common cause of latency spikes and for
many systems significant effort is spent on controlling these pauses.</p>
</div>
<div class="paragraph">
<p>Many logging libraries, including previous versions of Log4j, allocate
temporary objects like log event objects, Strings, char arrays, byte
arrays and more during steady state logging. This contributes to
pressure on the garbage collector and increases the frequency with which
GC pauses occur.</p>
</div>
<div class="paragraph">
<p>From version 2.6, Log4j runs in "garbage free" mode by default where
objects and buffers are reused and no temporary objects are allocated as
much as possible. There is also a "low garbage" mode which is not
completely garbage free but does not use ThreadLocal fields. This is the
default mode when Log4j <a href="#Config">detects</a> it is running in a web
application. Finally, it is possible to switch off all garbage-free
logic and run in "classic mode" instead. For details, see the
<a href="#Config">Configuration</a> section below.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jfr"><a class="anchor" href="#jfr"></a>A Contrived Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To highlight the difference that garbage-free logging can make, we used
Java Flight Recorder to measure a simple application that does nothing
but log a simple string as often as possible for about 12 seconds.</p>
</div>
<div class="paragraph">
<p>The application was configured to use Async Loggers, a RandomAccessFile
appender and a "%d %p %c{1.} [%t] %m %ex%n" pattern layout. (Async
Loggers used the Yield WaitStrategy.)</p>
</div>
<div class="paragraph">
<p>Mission Control shows that with Log4j 2.5 this application allocates
memory at a rate of about 809 MB/sec, resulting in 141 minor
collections. Log4j 2.6 does not allocate temporary objects in this
configuration, and as a result the same application with Log4j 2.6 has a
memory allocation rate of 1.6 MB/sec and was GC-free with 0 (zero)
garbage collections.</p>
</div>
<div class="paragraph">
<div class="title">Using Log4j 2.5: memory allocation rate 809 MB/sec, 141 minor collections</div>
<p><span class="image xref-image"><a class="image" href="../_images/log4j-2.5-FlightRecording.png"><img src="../_images/log4j-2.5-FlightRecording-thumbnail40pct.png" alt="log4j 2.5 FlightRecording thumbnail40pct"></a></span></p>
</div>
<div class="paragraph">
<div class="title">Using Log4j 2.6: no temporary object allocations, 0 (zero) garbage collections</div>
<p><span class="image xref-image"><a class="image" href="../_images/log4j-2.6-FlightRecording.png"><img src="../_images/log4j-2.6-FlightRecording-thumbnail40pct.png" alt="log4j 2.6 FlightRecording thumbnail40pct"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Config"><a class="anchor" href="#Config"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Garbage-free logging in Log4j 2.6 is partially implemented by reusing
objects in ThreadLocal fields, and partially by reusing buffers when
converting text to bytes.</p>
</div>
<div class="paragraph">
<p>ThreadLocal fields holding non-JDK classes can cause memory leaks in web
applications when the application server&#8217;s thread pool continues to
reference these fields after the web application is undeployed. To avoid
causing memory leaks, Log4j will not use these ThreadLocals when it
detects that it is used in a web application (when the
<code>javax.servlet.Servlet</code> class is in the classpath, or when system
property <code>log4j2.isWebapp</code> is set to "true").</p>
</div>
<div class="paragraph">
<p>Some garbage-reducing functionality does not rely on ThreadLocals and is
enabled by default for all applications: in Log4j 2.6, converting log
events to text and text to bytes can be done by directly encoding text
into a reused ByteBuffer without creating intermediary Strings, char
arrays and byte arrays. So while logging is not completely garbage-free
for web applications yet, the pressure on the garbage collector can
still be significantly reduced.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As of version 2.6, a Log4j configuration containing a
<code>&lt;Properties&gt;</code> section will result in temporary objects being created
during steady-state logging.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
as of version 2.18.0, the default Async Logger wait strategy used by Log4j
(Timeout) is garbage-free. Some of the wait strategies included in LMAX disruptor 3.4.4,
especially <code>TimeoutBlockingWaitStrategy</code> and <code>BlockingWaitStrategy</code> (Block)
are not garbage-free since they
cause <code>java.util.concurrent.locks.AbstractQueuedSynchronizer$Node</code> objects to be created.
The default wait strategy used by Log4j uses a synchronized block instead of a ReentrantLock to avoid this problem.
The Yield and Sleep wait strategies are garbage-free. (For configuring predefined wait strategies, see
<a href="async.html#SysPropsAllAsync" class="xref page">here</a> and
<a href="async.html#SysPropsMixedSync-Async" class="xref page">here</a>,
you may also configure a <a href="async.html#WaitStrategy" class="xref page">custom wait strategy</a>.)
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_disabling_garbage_free_logging"><a class="anchor" href="#_disabling_garbage_free_logging"></a>Disabling Garbage-free Logging</h3>
<div class="paragraph">
<p>There are separate system properties for manually controlling the
mechanisms Log4j uses to avoid creating temporary objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>log4j2.enableThreadlocals - if "true" (the default for non-web applications) objects are stored in ThreadLocal fields and reused, otherwise new objects are created for each log event.</p>
</li>
<li>
<p><code>log4j2.enableDirectEncoders</code> - if "true" (the default) log events are
converted to text and this text is converted to bytes without creating
temporary objects. Note: <em>synchronous</em> logging performance may be worse
for multi-threaded applications in this mode due to synchronization on
the shared buffer. If your application is multi-threaded and logging
performance is important, consider using Async Loggers.</p>
</li>
<li>
<p>The ThreadContext map is <em>not</em> garbage-free by default, but from Log4j
2.7 it can be configured to be garbage-free by setting system property
<code>log4j2.garbagefreeThreadContextMap</code> to "true".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead of system properties, the above properties can also be specified
in a file named <code>log4j2.component.properties</code> by including this file in
the classpath of the application. See the
<a href="configuration.html#SystemProperties" class="xref page">manual regarding system
properties</a> for more info.</p>
</div>
</div>
<div class="sect2">
<h3 id="Appenders"><a class="anchor" href="#Appenders"></a>Supported Appenders</h3>
<div class="paragraph">
<p>The following <a href="appenders.html" class="xref page">appenders</a> are garbage-free during
steady-state logging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Console</p>
</li>
<li>
<p>File</p>
</li>
<li>
<p>RollingFile (some temporary objects are created during file rollover)</p>
</li>
<li>
<p>RandomAccessFile</p>
</li>
<li>
<p>RollingRandomAccessFile (some temporary objects are created during
file rollover)</p>
</li>
<li>
<p>MemoryMappedFile</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any other appenders not in the above list (including AsyncAppender)
create temporary objects during steady-state logging. Instead of
AsyncAppender, use <a href="async.html" class="xref page">Async Loggers</a> to log asynchronously
in a garbage-free manner.</p>
</div>
</div>
<div class="sect2">
<h3 id="Filters"><a class="anchor" href="#Filters"></a>Supported Filters</h3>
<div class="paragraph">
<p>The following <a href="filters.html" class="xref page">filters</a> are garbage-free during
steady-state logging:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CompositeFilter (adding and removing element filters creates temporary
objects for thread safety)</p>
</li>
<li>
<p>DynamicThresholdFilter</p>
</li>
<li>
<p>LevelRangeFilter (garbage free since 2.8)</p>
</li>
<li>
<p>MapFilter (garbage free since 2.8)</p>
</li>
<li>
<p>MarkerFilter (garbage free since 2.8)</p>
</li>
<li>
<p>StructuredDataFilter (garbage free since 2.8)</p>
</li>
<li>
<p>ThreadContextMapFilter (garbage free since 2.8)</p>
</li>
<li>
<p>ThresholdFilter (garbage free since 2.8)</p>
</li>
<li>
<p>TimeFilter (garbage free since 2.8 except when range must be recalculated once per day)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other filters like BurstFilter, RegexFilter and ScriptFilter are not
trivial to make garbage free, and there is currently no plan to change
them.</p>
</div>
</div>
<div class="sect2">
<h3 id="Layouts"><a class="anchor" href="#Layouts"></a>Supported Layouts</h3>
<div class="sect3">
<h4 id="_gelflayout"><a class="anchor" href="#_gelflayout"></a>GelfLayout</h4>
<div class="paragraph">
<p>GelfLayout is garbage-free when used with compressionType="OFF", as long as no additional field contains '${' (variable substitution).</p>
</div>
</div>
<div class="sect3">
<h4 id="_jsontemplatelayout"><a class="anchor" href="#_jsontemplatelayout"></a>JsonTemplateLayout</h4>
<div class="paragraph">
<p><code>JsonTemplateLayout</code> is garbage-free with
<a href="json-template-layout.html#faq-garbage-free" class="xref page">a few exceptions</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_patternlayout"><a class="anchor" href="#_patternlayout"></a>PatternLayout</h4>
<div class="paragraph">
<p>PatternLayout with the following limited set of conversion patterns is
garbage-free. Format modifiers to control such things as field width,
padding, left and right justification will not generate garbage.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Conversion Pattern</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%c{precision}, %logger{precision}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logger name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d, %date</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note: Only the predefined date formats are garbage-free: (millisecond
separator may be either a comma ',' or a period '.')</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pattern</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{DEFAULT}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-11-02 14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{ISO8601}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-11-02T14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{ISO8601_BASIC}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20121102T143402,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{ABSOLUTE}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{DATE}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">02 Nov 2012 14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{COMPACT}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20121102143402781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{HH:mm:ss,SSS}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{dd MMM yyyy HH:mm:ss,SSS}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">02 Nov 2012 14:34:02,781</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{HH:mm:ss}{GMT+0}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18:34:02</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{UNIX}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1351866842</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%d{UNIX_MILLIS}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1351866842781</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%enc{pattern}, %encode{pattern}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encodes special characters such as
'\n' and HTML characters to help prevent log forging and some XSS
attacks that could occur when displaying logs in a web browser -
garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%equals{pattern}{test}{substitution},
%equalsIgnoreCase{pattern}{test}{substitution}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Replaces occurrences
of 'test', a string, with its replacement 'substitution' in the string
resulting from evaluation of the pattern - garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%highlight{pattern}{style}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds ANSI colors - garbage-free since 2.7
(unless nested pattern is not garbage free)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%K{key}, %map{key}, %MAP{key}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outputs the entries in a
<a href="../javadoc/log4j-api/org/apache/logging/log4j/message/MapMessage.html">MapMessage</a>,
if one is present in the event - garbage-free since 2.8.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%m, %msg, %message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log message (garbage-free unless message text
contains '${')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%marker</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The full name of the marker (including parents) - garbage-free
since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%markerSimpleName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The simple name of the marker (not including
parents)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%maxLen, %maxLength</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Truncates another pattern to some max number of
characters - garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%n</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The platform dependent line separator</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%N, %nano</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System.nanoTime() when the event was logged</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%notEmpty{pattern}, %varsNotEmpty{pattern},
%variablesNotEmpty{pattern}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outputs the result of evaluating the
pattern if and only if all variables in the pattern are not empty -
garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%p, %level</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The level of the logging event</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%r, %relative</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of milliseconds elapsed since the JVM was
started until the creation of the logging event - garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%sn, %sequenceNumber</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A sequence number that will be incremented in
every event - garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%style{pattern}{ANSI style}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Style the message - garbage-free since
2.7 (unless nested pattern is not garbage free)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%T, %tid, %threadId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The ID of the thread that generated the logging
event</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%t, %tn, %thread, %threadName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the thread that generated
the logging event</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%tp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The priority of the thread that generated the logging event</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>%X{key[,key2&#8230;&#8203;]}, %mdc{key[,key2&#8230;&#8203;]}, %MDC{key[,key2&#8230;&#8203;]}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Outputs
the Thread Context Map (also known as the Mapped Diagnostic Context or
MDC) associated with the thread that generated the logging event -
garbage-free since 2.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>literal text</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Garbage-free unless literal contains '${' (variable
substitution)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Other PatternLayout conversion patterns, and other Layouts may be
updated to avoid creating temporary objects in future releases. (Patches
welcome!)</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Logging exceptions and stack traces will create temporary
objects with any layout. (However, Layouts will only create these
temporary objects when an exception actually occurs.) We haven&#8217;t figured
out a way to log exceptions and stack traces without creating temporary
objects. That is unfortunate, but you probably still want to log them
when they happen.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
patterns containing regular expressions and lookups for property
substitution will result in temporary objects being created during
steady-state logging.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Including location information is done by walking the stacktrace of an
exception, which creates temporary objects, so the following patterns
are not garbage-free:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>%C, %class - Class Name</p>
</li>
<li>
<p>%F, %file - File Location</p>
</li>
<li>
<p>%l, %location - Location</p>
</li>
<li>
<p>%L, %line - Line Location</p>
</li>
<li>
<p>%M, %method - Method Location</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, the pattern converters for formatting Throwables are not
garbage-free:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>%ex, %exception, %throwable - The Throwable trace bound to the
LoggingEvent</p>
</li>
<li>
<p>%rEx, %rException %rThrowable - Same as %ex but with wrapping
exceptions</p>
</li>
<li>
<p>%xEx, %xException, %xThrowable - Same as %ex but with class packaging
information</p>
</li>
<li>
<p>%u, %uuid - Creates a new random or time-based UUID while formatting</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api"><a class="anchor" href="#api"></a>API Changes</h3>
<div class="paragraph">
<p>Methods have been added to the <code>Logger</code> interface so that no vararg
array objects are created when logging messages with up to ten
parameters.</p>
</div>
<div class="paragraph">
<p>Also, methods have been added to the <code>Logger</code> interface to log
<code>java.lang.CharSequence</code> messages. User-defined objects that implement
the <code>CharSequence</code> interface can be logged without creating temporary
objects: Log4j will try to turn CharSequence messages, Object messages
and message parameters into text by appending them to a StringBuilder as
a CharSequence. This avoids calling <code>toString()</code> on these objects.</p>
</div>
<div class="paragraph">
<p>An alternative is to implement the
<a href="http://logging.apache.org/log4j/2.x/log4j-api/xref/org/apache/logging/log4j/util/StringBuilderFormattable.html"><code>org.apache.logging.log4j.util.StringBuilderFormattable</code></a>
interface. If an object is logged that implements this interface, its
<code>formatTo</code> method is called instead of <code>toString()</code>.</p>
</div>
<div class="paragraph">
<p>Log4j may call toString() on message and parameter objects when garbage-free logging is disabled (when system property log4j2.enableThreadlocals is set to "false".)</p>
</div>
</div>
<div class="sect2">
<h3 id="codeImpact"><a class="anchor" href="#codeImpact"></a>Impact on Application Code: Autoboxing</h3>
<div class="paragraph">
<p>We made an effort to make logging garbage-free without requiring code
changes in existing applications, but there is one area where this was
not possible. When logging primitive values (i.e. int, double, boolean,
etc.) the JVM autoboxes these primitive values to their Object wrapper
equivalents, creating garbage.</p>
</div>
<div class="paragraph">
<p>Log4j provides an <code>Unbox</code> utility to prevent autoboxing of primitive
parameters. This utility contains a thread-local pool of reused
<code>StringBuilder`s. The `Unbox.box(primitive)</code> methods write directly into
a StringBuilder, and the resulting text will be copied into the final
log message text without creating temporary objects.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static org.apache.logging.log4j.util.Unbox.box;

// ...
public void garbageFree() {
    logger.debug("Prevent primitive autoboxing {} {}", box(10L), box(2.6d));
}</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
not all logging is garbage free. Specifically:
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>The ThreadContext map is not garbage-free by default, but can be
configured to be garbage-free by setting system property
<code>log4j2.garbagefreeThreadContextMap</code> to "true".</p>
</li>
<li>
<p>The ThreadContext stack is not garbage-free.</p>
</li>
<li>
<p>Logging more than 10 parameters creates vararg arrays.</p>
</li>
<li>
<p>Logging very large messages (more than 518 characters) when all
loggers are Async Loggers will cause the internal StringBuilder in the
RingBuffer to be trimmed back to their max size.</p>
</li>
<li>
<p>Logging messages containing '${': substituting a <code>${variable}</code> creates
temporary objects.</p>
</li>
<li>
<p>Logging a lambda <em>as a parameter</em>
(<code>logger.info("lambda value is {}", () &#8594; callExpensiveMethod())</code>)
creates a vararg array. Logging a lambda expression by itself is
garbage-free: <code>logger.debug) &#8594; callExpensiveMethod(</code>.</p>
</li>
<li>
<p>The <code>Logger.traceEntry</code> and <code>Logger.traceExit</code> methods create
temporary objects.</p>
</li>
<li>
<p>Time calculations are not garbage free when log4j2.usePreciseClock is set to true.
The default is false.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Performance"><a class="anchor" href="#Performance"></a>Performance</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Latency"><a class="anchor" href="#Latency"></a>Response Time Latency</h3>
<div class="paragraph">
<p>Response time is how long it takes to log a message under a certain
load. What is often reported as latency is actually <em>service time</em>: how
long it took to perform the operation. This hides the fact that a single
spike in service time adds queueing delay for many of the subsequent
operations. Service time is easy to measure (and often looks good on
paper) but is irrelevant for users since it omits the time spent waiting
for service. For this reason we report response time: service time plus
wait time. See the <a href="performance.html#responseTime" class="xref page">response time
section</a> of the performance page for more detail.</p>
</div>
<div class="paragraph">
<p>The response time test results below were all derived from running the
ResponseTimeTest class which can be found in the Log4j 2 unit test
source directory. If you want to run these tests yourself, here are the
command line options we used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-Xms1G -Xmx1G (prevent heap resizing during the test)</p>
</li>
<li>
<p>-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
-DAsyncLogger.WaitStrategy=busyspin (to use Async Loggers. The BusySpin
wait strategy reduces some jitter.)</p>
</li>
<li>
<p><strong>classic mode:</strong> -Dlog4j2.enable.direct.encoders=false<br>
<strong>garbage-free mode:</strong> -Dlog4j2.enable.direct.encoders=true</p>
</li>
<li>
<p>-XX:CompileCommand=dontinline,org.apache.logging.log4j.core.async.perftest.NoOpIdleStrategy::idle</p>
</li>
<li>
<p>-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps
-XX:+PrintTenuringDistribution -XX:+PrintGCApplicationConcurrentTime
-XX:+PrintGCApplicationStoppedTime (to eyeball GC and safepoint pauses)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_async_loggers"><a class="anchor" href="#_async_loggers"></a>Async Loggers</h3>
<div class="paragraph">
<p>The graph below compares "classic" logging to garbage-free logging
response time behaviour for Log4j&#8217;s Async Loggers. In the graph, "100k"
means logging at a sustained load of 100,000 messages/second, "800k" is
a sustained load of 800,000 messages/second.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/ResponseTimeAsyncClassicVsGcFree-label.png" alt="image"></span></p>
</div>
<div class="paragraph">
<p>In <strong>classic</strong> mode we see numerous minor garbage collections which pause
the application threads for 3 milliseconds or more. This quickly adds up
to response time delays of almost 10 milliseconds. As you can see in the
graph, increasing the load shifts the curve to the left (there are more
spikes). This makes sense: logging more means more pressure on the
garbage collector resulting in more minor GC pauses. We experimented a
little with reducing the load to 50,000 or even 5000 messages/second,
but this did not eliminate the 3 millisecond pauses, it just made them
occur less frequently. Note that all GC pauses in this test are minor GC
pauses. We did not see any full garbage collections.</p>
</div>
<div class="paragraph">
<p>In <strong>garbage-free</strong> mode, maximum response time remains well below 1
millisecond under a wide range of loads. (Max 780 us at 800,000
messages/sec, max 407 us at 600,000 messages/sec, with the 99% around 5
us for all loads up to 800,000 messages/sec.) Increasing or decreasing
the load does not change the response time behaviour. We did not
investigate the cause of the 200-300 microsecond pauses we saw in these
tests.</p>
</div>
<div class="paragraph">
<p>When we increased the load further we begin to see larger response time
pauses for both classic and garbage-free logging. At sustained loads of
1 million messages/second or more we start to approach the maximum
throughput of the underlying RandomAccessFile Appender (see the
synchronous logging throughput chart below). At these loads the
ringbuffer starts to fill up and backpressure kicks in: attempting to
add another message when the ringbuffer is full will block until a free
slot becomes available. We start to see response times of tens of
milliseconds or more; and attempting to increase the load even more
results in larger and larger response time spikes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_synchronous_file_logging"><a class="anchor" href="#_synchronous_file_logging"></a>Synchronous File Logging</h3>
<div class="paragraph">
<p>With synchronous file logging, garbage-free logging still performs
better than classic logging, but the difference is less pronounced.</p>
</div>
<div class="paragraph">
<p>At a workload of 100,000 messages/second, classic logging max response
time was a little over 2 milliseconds where garbage-free logging was a
little over 1 millisecond. When the workload is increased to 300,000
messages/second, classic logging shows response time pauses of 6
milliseconds where the garbage-free response times were less than 3
milliseconds. It may be possible to improve on this, we did not
investigate further yet.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/ResponseTimeSyncClassicVsGcFree.png" alt="image"></span></p>
</div>
<div class="paragraph">
<p>The above results are obtained with the ResponseTimeTest class which can
be found in the Log4j 2 unit test source directory, running on JDK
1.8.0_45 on RHEL 6.5 (Linux 2.6.32-573.1.1.el6.x86_64) with 10-core Xeon
CPU E5-2660 v3 @2.60GHz with hyperthreading switched on (20 virtual
cores).</p>
</div>
</div>
<div class="sect2">
<h3 id="Throughput"><a class="anchor" href="#Throughput"></a>Classic Logging has Slightly Higher Throughput</h3>
<div class="paragraph">
<p>Throughput is slightly worse for garbage-free logging, compared to
classic logging. This is true for both synchronous and asynchronous
logging. The graph below compares the sustained throughput of
synchronous logging to a file with Log4j 2.6 in garbage-free mode,
classic mode and Log4j 2.5.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../_images/garbage-free2.6-SyncThroughputLinux.png" alt="Throughput of Log4j 2.6 in garbage-free mode is slightly worse than in classic mode" width="but on par with 2.5 and much better than alternatives logging libraries"></span></p>
</div>
<div class="paragraph">
<p>The results above are obtained with the
<a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> Java benchmark
harness. See the FileAppenderBenchmark source code in the log4j-perf-test
module.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="UnderTheHood"><a class="anchor" href="#UnderTheHood"></a>Under the Hood</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Custom Message implementations that implement
<code>org.apache.logging.log4j.util.StringBuilderFormattable</code> can be
converted to text by garbage-free Layouts without creating temporary
objects. PatternLayout uses this mechanism and other layouts that
convert LogEvents to text will likely also look for this interface.</p>
</div>
<div class="paragraph">
<p>Custom Layouts that want to be garbage-free should implement the
<code>Encoder&lt;LogEvent&gt;</code> interface. For custom Layouts that convert a
LogEvent to a text representation, the
<code>org.apache.logging.log4j.core.layout.StringBuilderEncoder</code> class may be
useful to convert this text to bytes in a garbage-free manner.</p>
</div>
<div class="paragraph">
<p>Custom Appenders that want to be garbage-free should provide their
Layout with a <code>ByteBufferDestination</code> implementation that the Layout can
directly write into.</p>
</div>
<div class="paragraph">
<p><code>AbstractOutputStreamAppender</code> has been modified to make the
ConsoleAppender, (Rolling)FileAppender,
(Rolling)RandomAccessFileAppender and MemoryMappedFileAppender
garbage-free. An effort has been made to minimize impact on custom
Appenders that extend <code>AbstractOutputStreamAppender</code>, but it is
impossible to guarantee that changing the superclass will not impact any
and all subclasses. Custom Appenders that extend
<code>AbstractOutputStreamAppender</code> should verify that they still function
correctly. In case there is a problem, system property
<code>log4j2.enable.direct.encoders</code> can be set to "false" to revert to the
pre-Log4j 2.6 behaviour.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>
    Copyright Â© 1999-2024 <a href="https://www.apache.org/">The Apache Software Foundation</a>.
    Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache Software License, Version 2.0</a>.
    Please read our <a href="https://privacy.apache.org/policies/privacy-policy-public.html">privacy policy</a>.
  </p>
  <p>
    Apache, Log4j, and the Apache feather logo are trademarks or registered trademarks of The Apache Software Foundation.
    Oracle and Java are registered trademarks of Oracle and/or its affiliates.
    Other names may be trademarks of their respective owners.
  </p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<!-- `@asciidoctor/tabs` extension scripts -->
<script async src="../_/js/vendor/tabs.js"></script>
  </body>
</html>
